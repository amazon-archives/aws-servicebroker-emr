- name: Launch EMR cluster
  cloudformation:
   aws_access_key: "{{ aws_access_key }}"
   aws_secret_key: "{{ aws_secret_key }}"
   stack_name: "apb-emr-{{ stack_identifier }}"
   state: "present"
   region: "{{ region }}"
   disable_rollback: false
   template: "{{ role_path }}/files/emrcluster.yml"
   template_parameters:
     Applications: "{{ ApplicationName }}"
     EMRClusterName: "{{ EMRClusterName }}"
     KeyName: "{{ KeyName}}"
     MasterInstanceType: "{{ MasterInstanceType }}"
     CoreInstanceType: "{{ CoreInstanceType }}"
     NumberOfCoreInstances: "{{ NumberOfCoreInstances | string }}"
     SubnetID: "{{ SubnetID }}"
     LogUri: "{{ LogUri }}"
     S3DataUri: "{{ S3DataUri }}"
     ReleaseLabel: "{{ ReleaseLabel }}"
   tags:
     Stack: "ansible-cloudformation"
     Application: "ansible-emr"
     Description: "{{ ansible_user_id }} EMR {{ ApplicationName }}"
  register: emr
- name: Check for CloudFormation error logs
  debug:
    var: emr.log
- name: Encode bind credentials
  asb_encode_binding:
    fields:
      RECORD_NAME: "{{ emr.stack_outputs.S3DataUri }}"
  when: emr.log | length < 1